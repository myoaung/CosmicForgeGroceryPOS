name: Cosmic Forge CI (Safety Gate)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test_and_verify:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0' # Matches your project SDK
          channel: 'stable'

      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ğŸ›¡ï¸ Secret Scan (Safety Check)
        run: |
          if grep -q "SUPABASE_ANON_KEY=eyJ" .env 2>/dev/null; then
            echo "âŒ ERROR: Real .env file detected in repository! Blocking build."
            exit 1
          fi

      - name: ğŸ—ï¸ Verify Drift Code Generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ§ª Run POS Logic Tests
        # This runs your verified cart_provider_test and store_service_test
        run: flutter test

      - name: ğŸ“Š Check Migration Integrity
        # Ensures the agent didn't forget to commit the SQL files to infra/
        run: ls infra/supabase/migrations/*.sql
