# ðŸ“„ TECHNICAL SPECIFICATION: COSMIC FORGE GROCERY POS

## 1. PROJECT IDENTITY & SCOPE
- **Formal Brand**: Cosmic Forge Grocery POS.
- **Application ID**: `com.cosmicforge.pos`.
- **Primary Market**: Myanmar (Bilingual: English/Burmese).
- **Core Architecture**: Multi-tenant, Offline-First, SaaS-ready.

## 2. DATA ARCHITECTURE & ISOLATION
- **Storage Strategy**: Hybrid architecture using Shared PostgreSQL (Supabase) and Local SQLite (Drift).
- **Tenant Isolation**: 
  - Mandatory `tenant_id` (UUID) column in every database table.
  - Row-Level Security (RLS) enforcement: `tenant_id` MUST map to `auth.jwt() -> 'app_metadata' -> 'tenant_id'`.
- **Data Integrity**: 
  - **ACID Compliance**: All checkout operations (stock deduction + sales record) MUST wrap in a PostgreSQL Transaction.
  - **Audit Trail**: Every destructive action (VOID, REFUND, DELETE) must be logged in an immutable `audit_logs` table.

## 3. OFFLINE-FIRST SYNC PROTOCOL
- **Local Source of Truth**: During active sessions, all writes occur to the Local SQLite database.
- **Background Sync**: 
  - Uses **Version Vectors**: Each row contains `updated_at` (Timestamp) and `version` (Integer).
  - **Conflict Resolution**: 
    - Master Inventory: Last-Write-Wins (LWW) based on Client Timestamp.
    - Sales/Financials: Additive Merging to prevent revenue loss during concurrent sync.
- **Latency Requirement**: Data reconciliation must trigger automatically within < 50ms of network restoration.

## 4. MYANMAR LOCALIZATION & FISCAL LOGIC
- **Typography Standard**: Mandatory use of **Pyidaungsu Unicode** font for UI rendering and thermal receipt generation.
- **Currency Handling**: 
  - **Currency Code**: MMK (Myanmar Kyat).
  - **Cash Rounding**: Automated rounding to the nearest 5 or 10 Kyat for cash transactions.
- **Taxation Engine**: 
  - Default **5% Commercial Tax** calculation.
  - Per-item `is_tax_exempt` flag to handle essential goods (Rice, Cooking Oil, etc.).
- **Encoding**: Strictly UTF-8 Unicode (No Zawgyi support permitted in the database).

## 5. GROCERY-SPECIFIC LOGIC
- **Unit of Measure (UoM)**: 
  - **UNIT**: Integer-based (e.g., snacks, bottled water).
  - **WEIGHT**: Decimal-based with 6-digit precision for high-accuracy scales (e.g., meat, produce).
- **Barcode Engine**: 
  - EAN-13 parsing.
  - Prefix '2x' logic for price-embedded weight barcodes generated by in-store scales.
- **Khata System**: Digital customer credit ledger with immutable debt/repayment history.

## 6. SECURITY & COMPLIANCE
- **Hardware Binding**: Register activation requires valid **GPS Geofencing** (100m radius) and **BSSID (WiFi MAC)** verification.
- **VPN Guard**: Real-time detection and blocking of non-residential IP ranges via IP-API integration.
- **Role Permissions**: Hierarchical access (App Owner -> Store Owner -> Manager -> Cashier) enforced at the UI and DB layers.